<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CIAO | Tactical Body Recon</title>

    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">

    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="manifest.json">

    <!-- App Logic -->
    <script src="ciao_engine.js"></script>
    <script src="ciao_physics.js"></script>
    <script src="ciao_nutrition.js"></script>
    <script src="ciao_storage.js"></script>
</head>

<body>
    <div id="root"></div>

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(reg => console.log('SW Registered!', reg.scope))
                    .catch(err => console.log('SW Failed:', err));
            });
        }
    </script>

    <!-- Main Application Script -->
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { Engine, Physics, Storage, Nutrition } = window.CIAO;

        // --- COMPONENTS ---

        /* --- UI COMPONENTS --- */

        function Header() {
            return (
                <div className="site-header">
                    <div className="title-main">CIAO</div>
                    <div className="title-sub">TACTICAL RECON</div>
                    <div className="site-desc">CALORIC INTAKE ASSESSMENT & OPERATIONS // BODY METRICS DASHBOARD</div>
                </div>
            );
        }

        function Footer() {
            const [visitors, setVisitors] = useState(4200);

            useEffect(() => {
                const key = 'ciao_visitor_count';
                let current = localStorage.getItem(key);

                if (!current) {
                    // Random start between 4000 and 9000
                    current = 4000 + Math.floor(Math.random() * 5000);
                } else {
                    current = parseInt(current) + 1;
                }

                localStorage.setItem(key, current);
                setVisitors(current);
            }, []);

            return (
                <div className="site-footer">
                    <div className="footer-credit">Made with ☕ by Lenny Rajan</div>
                    <div className="visitor-count blink-cursor">VISITOR #{visitors}</div>
                </div>
            );
        }

        function Gauge({ label, value, max, colorClass, unit }) {
            const percent = Math.min(100, Math.max(0, (value / max) * 100));
            return (
                <div className="input-group">
                    <div className="flex justify-between" style={{ display: 'flex', justifyContent: 'space-between' }}>
                        <span className="input-label">{label}</span>
                        <span className="input-label" style={{ color: 'white' }}>{value} / {max} {unit}</span>
                    </div>
                    <div className="gauge-bar">
                        <div className={`gauge-fill ${colorClass}`} style={{ width: `${percent}%` }}></div>
                    </div>
                </div>
            );
        }

        function Onboarding({ onComplete }) {
            const [form, setForm] = useState({ weight: 80, height: 180, age: 30, gender: 'male', units: 'metric' });

            // Helper for Imperial Inputs (Feet/Inches)
            const [impHeight, setImpHeight] = useState({ ft: 5, in: 11 });

            // Effect to sync separate Imp state if we switched back to Imperial (optional, but good for UX)
            useEffect(() => {
                if (form.units === 'imperial') {
                    const totalInches = form.height / 2.54;
                    setImpHeight({ ft: Math.floor(totalInches / 12), in: Math.round(totalInches % 12) });
                }
            }, [form.units]);

            const [showTargetAcquired, setShowTargetAcquired] = useState(false);
            const [finalUser, setFinalUser] = useState(null);
            const [countdown, setCountdown] = useState(10);

            useEffect(() => {
                if (showTargetAcquired && countdown > 0) {
                    const timer = setTimeout(() => setCountdown(c => c - 1), 150); // Fast tactical count (150ms per tick)
                    return () => clearTimeout(timer);
                } else if (showTargetAcquired && countdown === 0) {
                    if (finalUser) {
                        onComplete(finalUser);
                    }
                }
            }, [showTargetAcquired, countdown, finalUser]);

            const handleSubmit = () => {
                const bmr = Engine.calculateBMR(form.weight, form.height, form.age, form.gender);
                const user = { ...form, bmr };
                Storage.saveUser(user);
                setFinalUser(user);
                setShowTargetAcquired(true);
            };

            const handleProceed = () => {
                if (finalUser) {
                    onComplete(finalUser);
                }
            };

            return (
                <div className="container">
                    <Header />
                    <div className="panel">
                        <span className="header-text">Identify Target</span>

                        <div className="input-group">
                            <label className="input-label">Unit System</label>
                            <div style={{ display: 'flex', gap: '10px' }}>
                                <button className={`btn ${form.units === 'metric' ? 'btn-primary' : ''}`} style={{ flex: 1, width: 'auto' }} onClick={() => setForm({ ...form, units: 'metric' })}>METRIC (kg/km)</button>
                                <button className={`btn ${form.units === 'imperial' ? 'btn-primary' : ''}`} style={{ flex: 1, width: 'auto' }} onClick={() => setForm({ ...form, units: 'imperial' })}>IMPERIAL (lbs/mi)</button>
                            </div>
                        </div>

                        <div className="input-group">
                            <label className="input-label">Weight ({form.units === 'metric' ? 'kg' : 'lbs'})</label>
                            <input
                                type="number"
                                className="tactical-input"
                                value={form.units === 'metric' ? form.weight : Math.round(form.weight * 2.20462)}
                                onChange={e => {
                                    const val = parseFloat(e.target.value) || 0;
                                    setForm({ ...form, weight: form.units === 'metric' ? val : val / 2.20462 });
                                }}
                            />
                        </div>

                        <div className="input-group">
                            <label className="input-label">Height ({form.units === 'metric' ? 'cm' : 'ft / in'})</label>
                            {form.units === 'metric' ? (
                                <button className={`btn ${form.goal === 'maintenance' ? 'btn-primary' : ''}`} style={{ textAlign: 'left' }} onClick={() => setForm({ ...form, goal: 'maintenance' })}>RECON [Maintain]</button>
                                <button className={`btn ${form.goal === 'bulk' ? 'btn-primary' : ''}`} style={{ textAlign: 'left' }} onClick={() => setForm({ ...form, goal: 'bulk' })}>ASSAULT [Gain +300]</button>
                            </div>
                        </div>

                        <button className="btn btn-primary" style={{ marginTop: '20px' }} onClick={handleSubmit}>Initialize System</button>
                    </div>
                    <Footer />

                    {/* TARGET ACQUIRED OVERLAY */ }
            {
                showTargetAcquired && (
                    <div style={{
                        position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.95)', zIndex: 999,
                        display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center'
                    }}>
                        <div className="panel" style={{
                            border: '2px solid var(--hud-green)',
                            padding: '40px',
                            textAlign: 'center',
                            maxWidth: '80%',
                            boxShadow: '0 0 30px rgba(0, 255, 65, 0.2)',
                            animation: 'fadeIn 0.5s ease-out'
                        }}>
                            <div className="blink-cursor" style={{
                                fontSize: '2em',
                                color: 'var(--hud-green)',
                                marginBottom: '20px',
                                letterSpacing: '5px',
                                fontWeight: 'bold',
                                textShadow: '0 0 10px var(--hud-green)'
                            }}>
                                TARGET ACQUIRED
                            </div>
                            <div style={{ color: '#fff', marginBottom: '30px', fontFamily: 'monospace' }}>
                                BIOMETRIC PARAMETERS LOCKED. RECONNAISSANCE SYSTEMS ONLINE.
                            </div>
                            <div style={{
                                fontSize: '4em',
                                fontWeight: 'bold',
                                color: 'var(--hud-green)',
                                fontFamily: 'monospace',
                                border: '2px dashed var(--hud-green)',
                                display: 'inline-block',
                                padding: '10px 30px',
                                background: 'rgba(0, 255, 65, 0.1)'
                            }}>
                                T-MINUS {countdown}
                            </div>
                        </div>
                    </div>
                )
            }
                </div >
            );
        }

        function Dashboard({ user, onReset, setUser }) {
            // Replaced handleResetSystem with prop call
            const handleResetSystem = onReset;
            // State: Itemized logs now
            const [activityLog, setActivityLog] = useState([]);
            const [foodLog, setFoodLog] = useState([]);
            const [showSettings, setShowSettings] = useState(false);
            const [showTrends, setShowTrends] = useState(false);
            const [weightEditMode, setWeightEditMode] = useState(false);
            const [newWeight, setNewWeight] = useState(user.weight);
            const [isLogOpen, setIsLogOpen] = useState(false);
            const [history, setHistory] = useState([]);

            // Food Form
            const [foodForm, setFoodForm] = useState({ name: '', quantity: 0, ratios: null, cals: 0, prot: 0, carbs: 0, fat: 0, fiber: 0, satFat: 0, airfry: false, bonePercent: 0, yieldPercent: 1.0 });

            // Load Daily Log (Migration Logic included)
            useEffect(() => {
                const log = Storage.getTodayLog();
                if (log) {
                    // Migration: if log.steps is a number, convert to [entry]
                    if (typeof log.steps === 'number') {
                        setActivityLog(log.steps > 0 ? [{ id: 'legacy-steps', amount: log.steps, timestamp: Date.now() }] : []);
                    } else {
                        setActivityLog(log.steps || []);
                    }

                    // Migration: if log.intake is single object, convert to [entry]
                    if (log.intake && !Array.isArray(log.intake) && log.intake.calories > 0) {
                        setFoodLog([{
                            id: 'legacy-food',
                            name: 'Legacy Entry',
                            ...log.intake,
                            timestamp: Date.now()
                        }]);
                    } else if (Array.isArray(log.intake)) {
                        setFoodLog(log.intake);
                    } else {
                        setFoodLog([]);
                    }
                }
                // Load history on mount
                setHistory(Storage.getHistory());
            }, []);

            // Save on Change (Save as arrays now)
            useEffect(() => {
                Storage.saveTodayLog({ steps: activityLog, intake: foodLog });
            }, [activityLog, foodLog]);

            // Calculations (Aggregating arrays)
            const steps = useMemo(() => activityLog.reduce((sum, item) => sum + (item.type === 'WORKOUT' ? 0 : item.amount), 0), [activityLog]);

            const intake = useMemo(() => foodLog.reduce((acc, item) => ({
                calories: acc.calories + item.calories,
                protein: acc.protein + item.protein,
                carbs: acc.carbs + item.carbs,
                fat: acc.fat + item.fat,
                fiber: (acc.fiber || 0) + (item.fiber || 0),
                satFat: (acc.satFat || 0) + (item.satFat || 0)
            }), { calories: 0, protein: 0, carbs: 0, fat: 0, fiber: 0, satFat: 0 }), [foodLog]);

            const tdee = Engine.calculateDynamicTDEE(user.bmr, steps);

            // Calculate Workout Burn
            const workoutBurn = useMemo(() => activityLog.reduce((sum, item) => sum + (item.type === 'WORKOUT' ? item.calories : 0), 0), [activityLog]);

            // Limit Adjust (Base TDEE + Workouts)
            const totalDailyBurn = tdee + workoutBurn; // BMR + Steps + Workouts
            const limit = Engine.adjustToGoal(totalDailyBurn, user.goal);

            // Balance Calculations
            const bmr = user.bmr;
            const stepBurn = Math.round((steps / 1000) * 40);
            const activeBurn = stepBurn + workoutBurn;
            const totalOutput = totalDailyBurn;

            // "Remaining" Logic (Target - Intake)
            const remaining = limit - intake.calories;

            let status = Engine.getMissionStatus(intake.calories, limit);

            // Re-using balance status logic for Remaining color coding
            let balanceColor = 'var(--hud-blue)';
            if (remaining < 0) balanceColor = 'var(--hud-red)';
            else if (remaining < 200) balanceColor = 'var(--hud-green)';

            // Smart Activity Form State
            const [actType, setActType] = useState('steps'); // steps, run, cycle, lift, sport, custom
            const [actForm, setActForm] = useState({ steps: '', duration: '', distance: '', name: '', calories: '' });

            // Autocomplete State
            const [scanQuery, setScanQuery] = useState('');
            const [scanQty, setScanQty] = useState(''); // Manual quantity override
            const [suggestions, setSuggestions] = useState([]);

            const handleSearchChange = (e) => {
                const val = e.target.value;
                setScanQuery(val);

                if (val.length > 0) {
                    const lower = val.toLowerCase();
                    const matches = Object.keys(Nutrition.OFFLINE_DB)
                        .filter(key => key.includes(lower))
                        .slice(0, 5); // Limit to top 5
                    setSuggestions(matches);
                } else {
                    setSuggestions([]);
                }
            };

            const selectSuggestion = (name) => {
                setScanQuery(name);
                setSuggestions([]);
            };

            // Handlers
            const handleAddSmartActivity = () => {
                let entry = null;

                if (actType === 'steps') {
                    const s = parseInt(actForm.steps);
                    if (s && !isNaN(s)) {
                        entry = { type: 'STEPS', amount: s };
                    }
                } else if (actType === 'custom') {
                    const cals = parseInt(actForm.calories);
                    if (actForm.name && cals && !isNaN(cals)) {
                        entry = { type: 'WORKOUT', name: actForm.name, calories: cals };
                    }
                } else {
                    // Smart MET Calculation
                    // Time Conversion: If 'walk' and hours input used, convert to minutes
                    let duration = parseFloat(actForm.duration) || 0;

                    const weight = user.weight;
                    let dist = parseFloat(actForm.distance) || 0;

                    // UNIT CONVERSION (Input -> Metric)
                    if (user.units === 'imperial' && dist > 0) {
                        dist = dist * 1.60934; // Miles to Km
                    }

                    // Calculate Burn (Engine handles missing duration if distance exists)
                    const burn = Engine.calculateActivityBurn(user.weight, actType, duration, dist);

                    if (burn > 0) {
                        // Create a descriptive name
                        let name = actType.toUpperCase();
                        if (dist) {
                            // Display value in chosen unit
                            const displayDist = user.units === 'imperial' ? (dist / 1.60934).toFixed(1) + 'mi' : dist.toFixed(1) + 'km';
                            name += ` (${displayDist})`;
                        }

                        // If duration was auto-calculated by engine (i.e. we only gave distance)
                        // we calculate it back here for the label so it doesn't say "0m"
                        let finalDuration = duration;
                        if (duration === 0 && dist > 0) {
                            // Re-infer for label (hacky duplication but safe)
                            const SPEEDS = { 'walk': 4.8, 'run': 9.0, 'cycle': 20.0 };
                            if (SPEEDS[actType]) finalDuration = Math.round((dist / SPEEDS[actType]) * 60);
                        }

                        name += ` - ${finalDuration}m`;

                        entry = { type: 'WORKOUT', name: name, calories: burn };
                    }
                }

                if (entry) {
                    setActivityLog(prev => [...prev, {
                        id: Date.now().toString(),
                        timestamp: Date.now(),
                        ...entry
                    }]);
                    // Reset proper fields
                    setActForm({ steps: '', duration: '', distance: '', name: '', calories: '' });
                }
            };

            const handleAddFood = () => {
                const base = {
                    protein: parseFloat(foodForm.prot) || 0,
                    carbs: parseFloat(foodForm.carbs) || 0,
                    fat: parseFloat(foodForm.fat) || 0,
                    fiber: parseFloat(foodForm.fiber) || 0,
                    satFat: parseFloat(foodForm.satFat) || 0,
                    calories: parseFloat(foodForm.cals) || 0
                };

                const final = Physics.applyPhysics(base, {
                    isAirFried: foodForm.airfry,
                    bonePercent: parseFloat(foodForm.bonePercent) / 100,
                    yieldPercent: parseFloat(foodForm.yieldPercent)
                });

                // Auto-append quantity to name if it exists and isn't already there
                let entryName = foodForm.name || 'Ration';
                if (foodForm.quantity > 0) {
                    const qtyStr = `(${foodForm.quantity}g)`;
                    if (!entryName.includes(qtyStr)) {
                        entryName += ` ${qtyStr}`;
                    }
                }

                const newEntry = {
                    id: Date.now().toString(),
                    name: entryName,
                    ...final,
                    timestamp: Date.now()
                };

                setFoodLog(prev => [...prev, newEntry]);
                setIsLogOpen(false);
                setFoodForm({ name: '', quantity: 0, ratios: null, cals: 0, prot: 0, carbs: 0, fat: 0, fiber: 0, satFat: 0, airfry: false, bonePercent: 0, yieldPercent: 1.0 });
            };

            const handleAddSteps = () => {
                const el = document.getElementById('stepsInput');
                const s = parseInt(el.value);
                if (s && !isNaN(s)) {
                    // Type: STEPS (Explicitly set to allow differentiation)
                    setActivityLog(prev => [...prev, { id: Date.now().toString(), type: 'STEPS', amount: s, timestamp: Date.now() }]);
                    el.value = '';
                }
            };

            const handleAddWorkout = () => {
                const nameEl = document.getElementById('workoutName');
                const calEl = document.getElementById('workoutCals');
                const name = nameEl.value;
                const cals = parseInt(calEl.value);

                if (name && cals && !isNaN(cals)) {
                    setActivityLog(prev => [...prev, {
                        id: Date.now().toString(),
                        type: 'WORKOUT',
                        name: name,
                        calories: cals,
                        timestamp: Date.now()
                    }]);
                    nameEl.value = '';
                    calEl.value = '';
                }
            };

            const deleteItem = (type, id) => {
                if (confirm("Confirm DELETE?")) {
                    if (type === 'food') setFoodLog(prev => prev.filter(i => i.id !== id));
                    else setActivityLog(prev => prev.filter(i => i.id !== id));
                }
            };

            // --- NEW FEATURES ---
            const [showReport, setShowReport] = useState(false);

            const handleCloseDay = () => {
                setShowReport(true);
            };

            const confirmCloseDay = () => {
                // 1. Create Mission Report Entry
                const report = {
                    date: new Date().toISOString().split('T')[0],
                    timestamp: Date.now(),
                    weight: user.weight,
                    intake: intake,
                    output: totalOutput,
                    balance: remaining, // Use remaining as a balance indicator
                    steps: steps,
                    foodLog: foodLog
                };

                // 2. Save to History
                Storage.saveHistory(report);

                // 3. Clear Day
                Storage.clearTodayLog();
                setFoodLog([]);
                setActivityLog([]);
                setShowReport(false);

                // 4. Update local history state
                setHistory(Storage.getHistory());

                alert("Day Closed. Intel secured in archives.");
            };

            const handleUpdateWeight = () => {
                console.log("Attempting to update weight...");
                const w = parseFloat(newWeight);
                if (w && w > 0) {
                    try {
                        const updated = { ...user, weight: w };
                        Storage.saveUser(updated);
                        setUser(updated);
                        setWeightEditMode(false);
                        console.log("Weight updated successfully to:", w);
                    } catch (e) {
                        alert("Storage Error: " + e.message);
                    }
                } else {
                    alert("Invalid Weight: Please enter a valid number > 0");
                }
            };

            // Trends Data Prep
            const chartData = history.slice(0, 7).reverse(); // Last 7 entries
            const maxTrackedCals = Math.max(...chartData.map(d => d.intake?.calories || 0), limit, 2500);

            return (
                <div className="container">
                    <Header />

                    {/* PROMOTION MODAL */}
                    {showPromo && (
                        <div className="panel" style={{ position: 'fixed', inset: 0, zIndex: 200, background: '#000', display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center', textAlign: 'center' }}>
                            <div style={{ fontSize: '4em', marginBottom: '20px' }}>⭐</div>
                            <h1 className="header-text" style={{ fontSize: '2em', color: 'var(--hud-blue)', marginBottom: '10px' }}>FIELD PROMOTION</h1>
                            <div style={{ color: '#888', marginBottom: '30px' }}>EXCELLENT WORK, OPERATIVE.</div>

                            <div style={{ background: '#111', padding: '20px', borderRadius: '8px', border: '1px solid var(--hud-blue)', width: '80%' }}>
                                <div style={{ fontSize: '0.8em', color: '#666' }}>NEW RANK ASSIGNED</div>
                                <div style={{ fontSize: '2.5em', fontWeight: 'bold', color: '#fff', marginTop: '10px' }}>{newRank}</div>
                            </div>

                            <button
                                className="btn btn-primary"
                                style={{ marginTop: '50px', width: '200px', fontSize: '1.2em' }}
                                onClick={() => setShowPromo(false)}
                            >
                                ACKNOWLEDGE
                            </button>
                        </div>
                    )}

                    {/* Report Modal */}
                    {showReport && (
                        <div className="panel" style={{ position: 'fixed', top: '10%', left: '5%', right: '5%', zIndex: 100, border: '2px solid var(--hud-blue)', background: '#000' }}>
                            <span className="header-text">DAILY MISSION REPORT</span>

                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px', textAlign: 'center', margin: '20px 0' }}>
                                <div>
                                    <div className="input-label">TOTAL INTAKE</div>
                                    <div className="value-huge">{intake.calories}</div>
                                </div>
                                <div>
                                    <div className="input-label">TOTAL OUTPUT</div>
                                    <div className="value-huge">{totalOutput}</div>
                                </div>
                            </div>

                            <div style={{ textAlign: 'center', margin: '15px 0' }}>
                                <div className="input-label">CURRENT WEIGHT</div>
                                <div style={{ fontSize: '1.5em', color: 'var(--hud-blue)' }}>{user.weight} {user.units === 'imperial' ? 'lbs' : 'kg'}</div>
                                <div style={{ fontSize: '0.8em', color: '#666' }}>Recorded in archive</div>
                            </div>

                            <div style={{ textAlign: 'center', borderTop: '1px solid #333', paddingTop: '10px' }}>
                                <div className="input-label">REMAINING ALLOWANCE</div>
                                <div className="value-huge" style={{ color: remaining < 0 ? 'var(--hud-red)' : 'var(--hud-blue)' }}>
                                    {remaining}
                                </div>
                            </div>

                            <div style={{ display: 'flex', gap: '10px', marginTop: '20px' }}>
                                <button className="btn" style={{ background: '#333' }} onClick={() => setShowReport(false)}>CANCEL</button>
                                <button className="btn btn-primary" onClick={confirmCloseDay}>CONFIRM END DAY</button>
                            </div>
                        </div>
                    )}

                    {/* TRENDS / INTEL VIEW */}
                    {showTrends && (
                        <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, zIndex: 90, background: '#000', overflowY: 'auto' }}>
                            <div className="container" style={{ minHeight: '100vh', background: '#000' }}>
                                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '20px', marginTop: '10px' }}>
                                    <span className="header-text">INTEL REPORT (LAST 7 SORTIES)</span>
                                    <button className="btn" style={{ width: 'auto' }} onClick={() => setShowTrends(false)}>CLOSE</button>
                                </div>

                                {history.length === 0 ? (
                                    <div style={{ textAlign: 'center', color: '#555', marginTop: '50px' }}>NO INTEL ARCHIVED. CLOSE A DAY TO GENERATE REPORTS.</div>
                                ) : (
                                    <div>
                                        {/* Chart Visualization (Simple Bars) */}
                                        <div style={{ height: '200px', display: 'flex', alignItems: 'flex-end', gap: '5px', padding: '10px', borderBottom: '1px solid #333', marginBottom: '20px' }}>
                                            {chartData.map((d, i) => (
                                                <div key={i} style={{ flex: 1, display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '5px' }}>
                                                    <div style={{
                                                        width: '100%',
                                                        background: (d.intake?.calories || 0) > limit ? 'var(--hud-red)' : 'var(--hud-green)',
                                                        height: `${((d.intake?.calories || 0) / maxTrackedCals) * 100}%`,
                                                        minHeight: '2px',
                                                        opacity: 0.8
                                                    }}></div>
                                                    <span style={{ fontSize: '0.6em', color: '#666' }}>{d.date.slice(5)}</span>
                                                </div>
                                            ))}
                                        </div>

                                        {/* Data Table */}
                                        {history.map((h, i) => {
                                            const net = (h.intake?.calories || 0) - (h.output || 0); // Need output stored, fallback 0
                                            let statusLabel = 'MAINTENANCE';
                                            let statusColor = '#888';

                                            if (net < -100) {
                                                statusLabel = `DEFICIT ${net}`;
                                                statusColor = 'var(--hud-green)';
                                            } else if (net > 100) {
                                                statusLabel = `SURPLUS +${net}`;
                                                statusColor = 'var(--hud-red)';
                                            }

                                            return (
                                                <div key={i} style={{ borderBottom: '1px solid #222', padding: '10px 0', fontSize: '0.9em' }}>
                                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', alignItems: 'center', marginBottom: '5px' }}>
                                                        <div>
                                                            <div style={{ color: 'var(--hud-blue)', fontWeight: 'bold' }}>{h.date}</div>
                                                            <div style={{ fontSize: '0.8em', color: '#888' }}>Weight: {h.weight || '?'} | Steps: {h.steps || 0}</div>
                                                        </div>
                                                        <div style={{ textAlign: 'right' }}>
                                                            <div style={{ color: statusColor, fontWeight: 'bold' }}>{statusLabel}</div>
                                                            <div style={{ fontSize: '0.8em', color: '#666' }}>Target: {limit} | In: {h.intake?.calories || 0}</div>
                                                        </div>
                                                    </div>

                                                    {/* Macro Breakdown Row */}
                                                    <div style={{ background: '#111', padding: '5px', borderRadius: '4px', fontSize: '0.8em', display: 'flex', justifyContent: 'space-between', color: '#aaa' }}>
                                                        <span>P: <span style={{ color: '#fff' }}>{h.intake?.protein || 0}</span></span>
                                                        <span>C: <span style={{ color: '#fff' }}>{h.intake?.carbs || 0}</span></span>
                                                        <span>F: <span style={{ color: '#fff' }}>{h.intake?.fat || 0}</span></span>
                                                        <span>Fib: <span style={{ color: '#fff' }}>{h.intake?.fiber || 0}</span></span>
                                                        <span>Sat: <span style={{ color: '#fff' }}>{h.intake?.satFat || 0}</span></span>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        </div>
                    )}

                    {/* Dark Overlay for Modal */}
                    {showReport && <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.8)', zIndex: 90 }}></div>}

                    {/* MISSION DATE & WEIGHT PANEL */}
                    <div className="panel" style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div>
                            <div className="input-label" style={{ marginBottom: '2px' }}>OFFICIAL DATE</div>
                            <div style={{ fontFamily: 'monospace', color: 'var(--hud-blue)', letterSpacing: '1px', fontSize: '0.9em' }}>
                                {new Date().toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }).toUpperCase()}
                            </div>
                        </div>

                        {weightEditMode ? (
                            <div style={{ display: 'flex', gap: '5px', alignItems: 'center' }}>
                                <input
                                    type="number"
                                    className="tactical-input"
                                    style={{ width: '80px', textAlign: 'center' }}
                                    value={newWeight}
                                    onChange={e => setNewWeight(e.target.value)}
                                />
                                <button className="btn" onClick={handleUpdateWeight} style={{ width: 'auto', padding: '5px 10px', background: 'var(--hud-green)', color: '#000' }}>SAVE</button>
                                <button className="btn-icon" onClick={() => setWeightEditMode(false)} style={{ color: 'var(--hud-red)', fontSize: '1.5em' }}>×</button>
                            </div>
                        ) : (
                            <div style={{ textAlign: 'right' }}>
                                <div className="input-label" style={{ marginBottom: '2px' }}>CURRENT FORM</div>
                                <div style={{ display: 'flex', alignItems: 'center', gap: '10px', justifyContent: 'flex-end' }}>
                                    <span style={{ fontSize: '1.2em', color: '#fff', fontWeight: 'bold' }}>
                                        {user.weight} <span style={{ fontSize: '0.6em', color: '#888' }}>{user.units === 'imperial' ? 'lbs' : 'kg'}</span>
                                    </span>
                                    <button
                                        className="btn"
                                        style={{ width: 'auto', padding: '2px 8px', fontSize: '0.7em', background: '#333', border: '1px solid #555' }}
                                        onClick={() => { setNewWeight(user.weight); setWeightEditMode(true); }}
                                    >
                                        UPDATE
                                    </button>
                                </div>
                            </div>
                        )}
                    </div>

                    {/* PANEL 1: REMAINING BUDGET (Critical Status) */}
                    <div className="panel" style={{ borderColor: balanceColor }}>
                        <span className="header-text">REMAINING RATION</span>
                        <div style={{ textAlign: 'center' }}>
                            <div className="value-huge" style={{ color: balanceColor }}>
                                {remaining}
                            </div>
                            <div className="input-label">KCAL LEFT</div>
                            <div style={{ marginTop: '10px', fontWeight: 'bold', color: balanceColor, border: '1px solid ' + balanceColor, padding: '5px', display: 'inline-block' }}>
                                {remaining < 0 ? 'MISSION COMPROMISED' : 'OPERATIONAL'}
                            </div>
                        </div>
                    </div>

                    {/* PANEL 2: TACTICAL OPS (Inputs) */}
                    <div className="panel">
                        <span className="header-text">TACTICAL OPS</span>
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                            <button className="btn" onClick={() => setIsLogOpen(!isLogOpen)}>LOG FOOD</button>

                            {/* Smart Activity Logger */}
                            <div className="input-group" style={{ margin: 0 }}>
                                <label className="input-label">LOG ACTIVITY</label>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '5px' }}>

                                    {/* Type Selector */}
                                    <div style={{ display: 'flex', gap: '5px' }}>
                                        <select className="tactical-input" style={{ width: '100%', cursor: 'pointer', background: '#222' }} value={actType} onChange={e => setActType(e.target.value)}>
                                            <option value="steps">STEPS (Standard)</option>
                                            <option value="walk">WALKING (Distance/Time)</option>
                                            <option value="run">RUNNING (High Intensity)</option>
                                            <option value="cycle">CYCLING (Moderate)</option>
                                            <option value="lift">LIFTING / GYM</option>
                                            <option value="sport">SPORTS (General)</option>
                                            <option value="custom">MANUAL ENTRY</option>
                                        </select>
                                    </div>

                                    {/* Dynamic Inputs */}
                                    <div style={{ display: 'flex', gap: '5px' }}>
                                        {actType === 'steps' && (
                                            <input type="number" className="tactical-input" placeholder="Count" value={actForm.steps} onChange={e => setActForm({ ...actForm, steps: e.target.value })} style={{ flex: 1 }} />
                                        )}

                                        {actType === 'walk' && (
                                            <>
                                                <input type="number" className="tactical-input" placeholder={user.units === 'imperial' ? "Miles" : "Km"} value={actForm.distance} onChange={e => setActForm({ ...actForm, distance: e.target.value })} style={{ flex: 1 }} />
                                                <input type="number" className="tactical-input" placeholder="Hrs (Opt)"
                                                    value={actForm.duration ? (actForm.duration / 60) : ''}
                                                    onChange={e => {
                                                        const val = parseFloat(e.target.value);
                                                        setActForm({ ...actForm, duration: val ? val * 60 : '' }); // Store as mins
                                                    }}
                                                    style={{ flex: 1 }}
                                                />
                                            </>
                                        )}

                                        {(actType === 'run' || actType === 'cycle') && (
                                            <>
                                                <input type="number" className="tactical-input" placeholder={user.units === 'imperial' ? "Miles" : "Km"} value={actForm.distance} onChange={e => setActForm({ ...actForm, distance: e.target.value })} style={{ flex: 1 }} />
                                                <input type="number" className="tactical-input" placeholder="Mins" value={actForm.duration} onChange={e => setActForm({ ...actForm, duration: e.target.value })} style={{ flex: 1 }} />
                                            </>
                                        )}

                                        {(actType === 'lift' || actType === 'sport') && (
                                            <input type="number" className="tactical-input" placeholder="Duration (Minutes)" value={actForm.duration} onChange={e => setActForm({ ...actForm, duration: e.target.value })} style={{ flex: 1 }} />
                                        )}

                                        {actType === 'custom' && (
                                            <>
                                                <input className="tactical-input" placeholder="Desc" value={actForm.name} onChange={e => setActForm({ ...actForm, name: e.target.value })} style={{ flex: 1 }} />
                                                <input type="number" className="tactical-input" placeholder="Kcal" value={actForm.calories} onChange={e => setActForm({ ...actForm, calories: e.target.value })} style={{ width: '80px' }} />
                                            </>
                                        )}

                                        <button className="btn" style={{ width: 'auto', padding: '0 15px' }} onClick={handleAddSmartActivity}>ADD</button>
                                    </div>

                                    {/* Preview (Optional Enhancement) */}
                                    {actType !== 'steps' && actType !== 'custom' && (actForm.duration || actForm.distance) && (
                                        <div style={{ textAlign: 'right', fontSize: '0.8em', color: 'var(--hud-green)' }}>
                                            ESTIMATED BURN: ~{Engine.calculateActivityBurn(user.weight, actType, parseFloat(actForm.duration) || 0, (parseFloat(actForm.distance) || 0) * (user.units === 'imperial' ? 1.60934 : 1))} kcal
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Food Logger (Expandable) Moved Here */}
                        {isLogOpen && (
                            <div className="panel" style={{ marginTop: '15px', border: '1px solid var(--hud-blue)' }}>
                                <span className="header-text" style={{ color: 'var(--hud-blue)' }}>NEW RATION ENTRY</span>
                                {/* Smart Scan */}
                                <div className="input-group" style={{ borderBottom: '1px solid #333', paddingBottom: '1rem', marginBottom: '1rem' }}>
                                    <label className="input-label">SMART SCAN (e.g. "300g Chicken")</label>
                                    <div style={{ display: 'flex', gap: '10px', position: 'relative' }}>
                                        <div style={{ flex: 2 }}>
                                            <input
                                                className="tactical-input"
                                                placeholder="Scan food..."
                                                id="smartInput"
                                                value={scanQuery}
                                                onChange={handleSearchChange}
                                                style={{ width: '100%' }}
                                                autoComplete="off"
                                            />
                                            {/* Autocomplete Dropdown */}
                                            {suggestions.length > 0 && (
                                                <div style={{
                                                    position: 'absolute',
                                                    top: '100%',
                                                    left: 0,
                                                    right: 0,
                                                    background: '#000',
                                                    border: '1px solid var(--hud-blue)',
                                                    zIndex: 50,
                                                    boxShadow: '0 4px 6px rgba(0,0,0,0.5)'
                                                }}>
                                                    {suggestions.map(s => (
                                                        <div
                                                            key={s}
                                                            style={{
                                                                padding: '10px',
                                                                cursor: 'pointer',
                                                                borderBottom: '1px solid #111',
                                                                color: '#fff',
                                                                textTransform: 'capitalize'
                                                            }}
                                                            onClick={() => selectSuggestion(s)}
                                                            className="suggestion-item"
                                                        >
                                                            {s}
                                                        </div>
                                                    ))}
                                                </div>
                                            )}
                                        </div>
                                        <div style={{ flex: 1 }}>
                                            <input
                                                type="number"
                                                className="tactical-input"
                                                placeholder="Qty"
                                                value={scanQty}
                                                onChange={e => setScanQty(e.target.value)}
                                                style={{ width: '100%' }}
                                                title="Optional manual quantity (grams or ml)"
                                            />
                                        </div>
                                        <button className="btn" onClick={async () => {
                                            const query = scanQuery;
                                            if (!query) return;
                                            try {
                                                const manualAmount = scanQty ? parseFloat(scanQty) : null;
                                                const items = await Nutrition.fetchNutrition(query, manualAmount);
                                                if (items && items.length > 0) {
                                                    const item = items[0];

                                                    // Auto-scaling Logic
                                                    const qty = item.serving_size_g || 100;
                                                    const ratios = {
                                                        cals: (item.calories || 0) / qty,
                                                        prot: (item.protein_g || item.protein || 0) / qty,
                                                        carbs: (item.carbohydrates_total_g || item.carbs || 0) / qty,
                                                        fat: (item.fat_total_g || item.fat || 0) / qty,
                                                        fiber: (item.fiber || 0) / qty,
                                                        satFat: (item.sat_fat || 0) / qty
                                                    };

                                                    // Strip "(100g)" or similar from the name to keep it clean
                                                    let cleanName = item.name.replace(/\(\d+g\)/i, '').trim();

                                                    setFoodForm({
                                                        name: cleanName,
                                                        quantity: qty,
                                                        ratios: ratios,
                                                        cals: item.calories,
                                                        prot: item.protein_g || item.protein,
                                                        carbs: item.carbohydrates_total_g || item.carbs,
                                                        fat: item.fat_total_g || item.fat,
                                                        fiber: item.fiber || 0,
                                                        satFat: item.sat_fat || 0,
                                                        airfry: false,
                                                        bonePercent: 0,
                                                        yieldPercent: 1.0
                                                    });
                                                    setScanQuery(''); // Clear after success
                                                    setScanQty('');
                                                    setSuggestions([]);
                                                } else {
                                                    alert("No intelligence found on this item.");
                                                }
                                            } catch (e) {
                                                alert("Scan Failed: " + e.message);
                                            }
                                        }}>SCAN</button>
                                    </div>
                                </div>

                                <div className="input-group">
                                    <label className="input-label">Name</label>
                                    <input className="tactical-input" value={foodForm.name} onChange={e => setFoodForm({ ...foodForm, name: e.target.value })} />
                                </div>

                                <div className="input-group">
                                    <label className="input-label" style={{ color: 'var(--hud-green)' }}>QUANTITY (g)</label>
                                    <input
                                        type="number"
                                        className="tactical-input"
                                        style={{ border: '1px solid var(--hud-green)' }}
                                        value={foodForm.quantity || ''}
                                        placeholder="Enter amount..."
                                        onChange={e => {
                                            const qty = parseFloat(e.target.value) || 0;
                                            const newState = { ...foodForm, quantity: qty };

                                            // Scale macros if ratios exist
                                            if (foodForm.ratios) {
                                                newState.cals = Math.round(qty * foodForm.ratios.cals);
                                                newState.prot = Math.round(qty * foodForm.ratios.prot);
                                                newState.carbs = Math.round(qty * foodForm.ratios.carbs);
                                                newState.fat = Math.round(qty * foodForm.ratios.fat);
                                                newState.fiber = Math.round(qty * foodForm.ratios.fiber);
                                                newState.satFat = Math.round(qty * foodForm.ratios.satFat);
                                            }

                                            setFoodForm(newState);
                                        }}
                                    />
                                </div>

                                {/* Compact Read-Only Macros */}
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1fr', gap: '5px', marginTop: '10px' }}>
                                    <div className="input-group" style={{ marginBottom: 0 }}>
                                        <label className="input-label" style={{ fontSize: '0.7em' }}>Prot</label>
                                        <input type="number" readOnly className="tactical-input" style={{ background: '#111', border: 'none', color: '#888', padding: '5px', fontSize: '0.9em' }} value={foodForm.prot} />
                                    </div>
                                    <div className="input-group" style={{ marginBottom: 0 }}>
                                        <label className="input-label" style={{ fontSize: '0.7em' }}>Carbs</label>
                                        <input type="number" readOnly className="tactical-input" style={{ background: '#111', border: 'none', color: '#888', padding: '5px', fontSize: '0.9em' }} value={foodForm.carbs} />
                                    </div>
                                    <div className="input-group" style={{ marginBottom: 0 }}>
                                        <label className="input-label" style={{ fontSize: '0.7em' }}>Fat</label>
                                        <input type="number" readOnly className="tactical-input" style={{ background: '#111', border: 'none', color: '#888', padding: '5px', fontSize: '0.9em' }} value={foodForm.fat} />
                                    </div>
                                    <div className="input-group" style={{ marginBottom: 0 }}>
                                        <label className="input-label" style={{ fontSize: '0.7em' }}>Fiber</label>
                                        <input type="number" readOnly className="tactical-input" style={{ background: '#111', border: 'none', color: '#888', padding: '5px', fontSize: '0.9em' }} value={foodForm.fiber} />
                                    </div>
                                    <div className="input-group" style={{ marginBottom: 0 }}>
                                        <label className="input-label" style={{ fontSize: '0.7em' }}>SatFat</label>
                                        <input type="number" readOnly className="tactical-input" style={{ background: '#111', border: 'none', color: '#888', padding: '5px', fontSize: '0.9em' }} value={foodForm.satFat} />
                                    </div>
                                    <div className="input-group" style={{ marginBottom: 0 }}>
                                        <label className="input-label" style={{ fontSize: '0.7em' }}>Kcal</label>
                                        <input type="number" readOnly className="tactical-input" style={{ background: '#111', border: 'none', color: '#fff', padding: '5px', fontSize: '0.9em' }} value={foodForm.cals} />
                                    </div>
                                </div>
                                <div className="input-group" style={{ display: 'flex', alignItems: 'center', gap: '10px', marginTop: '10px' }}>
                                    <input type="checkbox" id="af" checked={foodForm.airfry} onChange={e => setFoodForm({ ...foodForm, airfry: e.target.checked })} />
                                    <label htmlFor="af" className="input-label" style={{ marginBottom: 0 }}>AIR FRYER MODE (Reduces Fat)</label>
                                </div>

                                {/* Advanced Physics */}
                                <div className="panel" style={{ marginTop: '10px', background: 'rgba(0,0,0,0.3)' }}>
                                    <span className="input-label">PHYSICS MODIFIERS</span>
                                    <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                                        <div className="input-group">
                                            <label className="input-label">Bone % (Waste)</label>
                                            <input type="number" className="tactical-input" placeholder="e.g. 20" value={foodForm.bonePercent} onChange={e => setFoodForm({ ...foodForm, bonePercent: e.target.value })} />
                                        </div>
                                        <div className="input-group">
                                            <label className="input-label">Yield Factor (0-1)</label>
                                            <input type="number" className="tactical-input" placeholder="e.g. 1.0" value={foodForm.yieldPercent} onChange={e => setFoodForm({ ...foodForm, yieldPercent: e.target.value })} />
                                        </div>
                                    </div>
                                </div>

                                <button className="btn btn-primary" onClick={handleAddFood}>CONFIRM ENTRIES</button>
                            </div>
                        )}

                        <div style={{ marginTop: '10px', textAlign: 'center' }}>
                            <span className="input-label">CURRENT STEPS: {steps}</span>
                        </div>

                        <div style={{ borderTop: '1px solid #333', marginTop: '15px', paddingTop: '10px', display: 'flex', justifyContent: 'space-between' }}>
                            <button style={{ background: 'none', border: '1px solid var(--hud-red)', color: 'var(--hud-red)', padding: '5px 10px', fontSize: '0.8em', cursor: 'pointer' }} onClick={handleResetSystem}>RESET SYSTEM</button>
                            <button style={{ background: 'var(--hud-green)', border: 'none', color: '#000', padding: '5px 10px', fontSize: '0.8em', fontWeight: 'bold', cursor: 'pointer' }} onClick={() => setShowTrends(true)}>INTEL REPORT</button>
                            <button style={{ background: 'var(--hud-blue)', border: 'none', color: '#000', padding: '5px 10px', fontSize: '0.8em', fontWeight: 'bold', cursor: 'pointer' }} onClick={handleCloseDay}>CLOSE DAY</button>
                        </div>
                    </div>

                    {/* PANEL 3: MISSION STATUS (INTAKE) */}
                    <div className="panel" style={{ textAlign: 'center', borderColor: status.color }}>
                        <span className="header-text">MISSION INTAKE</span>
                        <div className="value-huge" style={{ color: status.color === 'red' ? 'var(--hud-red)' : 'var(--hud-green)' }}>
                            {intake.calories}
                        </div>
                        <span className="input-label" style={{ letterSpacing: '5px' }}>KCAL CONSUMED</span>

                        <div className="gauge-bar" style={{ marginTop: '15px' }}>
                            <div className={`gauge-fill ${status.color === 'red' ? 'fill-red' : 'fill-green'}`} style={{ width: `${Math.min(100, (intake.calories / limit) * 100)}%` }}></div>
                        </div>
                        <div style={{ marginTop: '5px', fontSize: '0.8em', color: status.color, textAlign: 'right' }}>
                            MISSION TARGET: {limit}
                        </div>
                    </div>

                    {/* Quick Stats */}
                    <div className="panel">
                        <Gauge label="PROTEIN" value={intake.protein} max={180} unit="g" colorClass="fill-blue" />
                        <Gauge label="CARBS" value={intake.carbs} max={200} unit="g" colorClass="fill-orange" />
                        <Gauge label="FAT" value={intake.fat} max={70} unit="g" colorClass="fill-purple" />
                        <Gauge label="CALORIES" value={intake.calories} max={limit} unit="kcal" colorClass={status.color === 'red' ? 'fill-red' : 'fill-green'} />
                    </div>

                    {/* MISSION LOG (HISTORY) */}
                    <div className="panel">
                        <span className="header-text" style={{ color: 'var(--text-dim)' }}>MISSION LOG</span>

                        {/* Food List */}
                        <div style={{ marginBottom: '10px' }}>
                            <div className="input-label" style={{ borderBottom: '1px solid #333' }}>RATIONS</div>
                            {foodLog.length === 0 && <div style={{ fontSize: '0.8em', color: '#555', fontStyle: 'italic' }}>No rations logged.</div>}
                            {foodLog.slice().reverse().map(item => (
                                <div key={item.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '5px 0', borderBottom: '1px dashed #222' }}>
                                    <div style={{ fontSize: '0.9em' }}>
                                        <span style={{ color: 'var(--hud-blue)' }}>{item.name}</span> <span style={{ fontSize: '0.8em', color: '#666' }}>({item.calories} kcal)</span>
                                    </div>
                                    <button style={{ background: 'none', border: 'none', color: 'var(--hud-red)', cursor: 'pointer', fontSize: '0.8em' }} onClick={() => deleteItem('food', item.id)}>[DEL]</button>
                                </div>
                            ))}
                        </div>

                        {/* Activity List */}
                        <div>
                            <div className="input-label" style={{ borderBottom: '1px solid #333' }}>ACTIVITY</div>
                            {activityLog.length === 0 && <div style={{ fontSize: '0.8em', color: '#555', fontStyle: 'italic' }}>No activity logged.</div>}
                            {activityLog.slice().reverse().map(item => (
                                <div key={item.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '5px 0', borderBottom: '1px dashed #222' }}>
                                    <div style={{ fontSize: '0.9em' }}>
                                        {item.type === 'WORKOUT' ? (
                                            <>
                                                <span style={{ color: 'var(--hud-orange)' }}>{item.name}</span> <span style={{ fontSize: '0.8em', color: '#666' }}>({item.calories} kcal)</span>
                                            </>
                                        ) : (
                                            <>
                                                <span style={{ color: 'var(--hud-green)' }}>Steps</span> <span style={{ fontSize: '0.8em', color: '#666' }}>({item.amount} / ~{Math.round((item.amount / 1000) * 40)} kcal)</span>
                                            </>
                                        )}

                                    </div>
                                    <button style={{ background: 'none', border: 'none', color: 'var(--hud-red)', cursor: 'pointer', fontSize: '0.8em' }} onClick={() => deleteItem('activity', item.id)}>[DEL]</button>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* FOOTER: MISSION BRIEFING (Reference Info) */}
                    <div className="panel" style={{ opacity: 0.8 }}>
                        <span className="header-text">SYSTEM PARAMETERS</span>

                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px', fontSize: '0.9em' }}>
                            <div>
                                <div className="input-label">BASE BMR</div>
                                <div style={{ color: '#fff' }}>{Math.round(bmr)} <span style={{ fontSize: '0.8em', color: '#666' }}></span></div>
                            </div>
                            <div style={{ textAlign: 'right' }}>
                                <div className="input-label">ACTIVE TDEE</div>
                                <div style={{ color: '#fff' }}>{Math.round(totalOutput)} <span style={{ fontSize: '0.8em', color: '#666' }}></span></div>
                            </div>
                        </div>

                        <div style={{ borderTop: '1px dashed #444', margin: '10px 0', padding: '10px 0' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                <span className="input-label">STRATEGY</span>
                                <span style={{ color: user.goal === 'cut' ? 'var(--hud-green)' : (user.goal === 'bulk' ? 'var(--hud-red)' : 'var(--hud-blue)') }}>
                                    {user.goal === 'cut' ? 'INFILTRATE (-500)' : (user.goal === 'bulk' ? 'ASSAULT (+300)' : 'RECON (MAINTAIN)')}
                                </span>
                            </div>
                        </div>
                    </div>

                    <Footer />
                </div >
            );
        }


        function App() {
            const [user, setUser] = useState(Storage.getUser());

            const handleOnboardingComplete = (newUser) => {
                setUser(newUser);
            };

            const handleReset = () => {
                if (confirm("FACTORY RESET: This will wipe all data. Confirm?")) {
                    Storage.clearAll();
                    setUser(null);
                }
            };

            if (!user) {
                return <Onboarding onComplete={handleOnboardingComplete} />;
            }

            return <Dashboard user={user} onReset={handleReset} setUser={setUser} />;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>