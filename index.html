<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CIAO | Tactical Body Recon</title>

    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">

    <!-- React & Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- App Logic -->
    <script src="ciao_engine.js"></script>
    <script src="ciao_physics.js"></script>
    <script src="ciao_nutrition.js"></script>
    <script src="ciao_storage.js"></script>
</head>

<body>
    <div id="root"></div>

    <!-- Main Application Script -->
    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { Engine, Physics, Storage, Nutrition } = window.CIAO;

        // --- COMPONENTS ---

        /* --- UI COMPONENTS --- */

        function Header() {
            return (
                <div className="site-header">
                    <div className="title-main">CIAO</div>
                    <div className="title-sub">TACTICAL RECON</div>
                    <div className="site-desc">CALORIC INTAKE ASSESSMENT & OPERATIONS // BODY METRICS DASHBOARD</div>
                </div>
            );
        }

        function Footer() {
            const [visitors, setVisitors] = useState(4200);

            useEffect(() => {
                const key = 'ciao_visitor_count';
                let current = localStorage.getItem(key);

                if (!current) {
                    // Random start between 4000 and 9000
                    current = 4000 + Math.floor(Math.random() * 5000);
                } else {
                    current = parseInt(current) + 1;
                }

                localStorage.setItem(key, current);
                setVisitors(current);
            }, []);

            return (
                <div className="site-footer">
                    <div className="footer-credit">Made with â˜• by Lenny Rajan</div>
                    <div className="visitor-count blink-cursor">VISITOR #{visitors}</div>
                </div>
            );
        }

        function Gauge({ label, value, max, colorClass, unit }) {
            const percent = Math.min(100, Math.max(0, (value / max) * 100));
            return (
                <div className="input-group">
                    <div className="flex justify-between" style={{ display: 'flex', justifyContent: 'space-between' }}>
                        <span className="input-label">{label}</span>
                        <span className="input-label" style={{ color: 'white' }}>{value} / {max} {unit}</span>
                    </div>
                    <div className="gauge-bar">
                        <div className={`gauge-fill ${colorClass}`} style={{ width: `${percent}%` }}></div>
                    </div>
                </div>
            );
        }

        function Onboarding({ onComplete }) {
            const [form, setForm] = useState({ weight: 80, height: 180, age: 30, gender: 'male' });

            const handleSubmit = () => {
                const bmr = Engine.calculateBMR(form.weight, form.height, form.age, form.gender);
                const user = { ...form, bmr };
                Storage.saveUser(user);
                onComplete(user);
            };

            return (
                <div className="container">
                    <Header />
                    <div className="panel">
                        <span className="header-text">Identify Target</span>
                        <div className="input-group">
                            <label className="input-label">Weight (kg)</label>
                            <input type="number" className="tactical-input" value={form.weight} onChange={e => setForm({ ...form, weight: parseFloat(e.target.value) })} />
                        </div>
                        <div className="input-group">
                            <label className="input-label">Height (cm)</label>
                            <input type="number" className="tactical-input" value={form.height} onChange={e => setForm({ ...form, height: parseFloat(e.target.value) })} />
                        </div>
                        <div className="input-group">
                            <label className="input-label">Age</label>
                            <input type="number" className="tactical-input" value={form.age} onChange={e => setForm({ ...form, age: parseFloat(e.target.value) })} />
                        </div>

                        <div className="input-group">
                            <label className="input-label">Bio-Gender (BMR Calc)</label>
                            <div style={{ display: 'flex', gap: '10px' }}>
                                <button className={`btn ${form.gender === 'male' ? 'btn-primary' : ''}`} style={{ flex: 1, width: 'auto' }} onClick={() => setForm({ ...form, gender: 'male' })}>MALE</button>
                                <button className={`btn ${form.gender === 'female' ? 'btn-primary' : ''}`} style={{ flex: 1, width: 'auto' }} onClick={() => setForm({ ...form, gender: 'female' })}>FEMALE</button>
                            </div>
                        </div>

                        <div className="input-group">
                            <label className="input-label">Mission Objective</label>
                            <div style={{ display: 'grid', gap: '5px' }}>
                                <button className={`btn ${form.goal === 'cut' ? 'btn-primary' : ''}`} style={{ textAlign: 'left' }} onClick={() => setForm({ ...form, goal: 'cut' })}>INFILTRATE [Fat Loss -500]</button>
                                <button className={`btn ${form.goal === 'maintenance' ? 'btn-primary' : ''}`} style={{ textAlign: 'left' }} onClick={() => setForm({ ...form, goal: 'maintenance' })}>RECON [Maintain]</button>
                                <button className={`btn ${form.goal === 'bulk' ? 'btn-primary' : ''}`} style={{ textAlign: 'left' }} onClick={() => setForm({ ...form, goal: 'bulk' })}>ASSAULT [Gain +300]</button>
                            </div>
                        </div>

                        <button className="btn btn-primary" style={{ marginTop: '20px' }} onClick={handleSubmit}>Initialize System</button>
                    </div>
                </div>
            );
        }

        function Dashboard({ user, onReset }) {
            // ... (existing state) ...

            // ... (useEffect logic exists here) ...

            // ... (handlers) ...

            // Replaced handleResetSystem with prop call
            const handleResetSystem = onReset;
            // State: Itemized logs now
            const [activityLog, setActivityLog] = useState([]);
            const [foodLog, setFoodLog] = useState([]);
            const [isLogOpen, setIsLogOpen] = useState(false);

            // Food Form
            const [foodForm, setFoodForm] = useState({ name: '', cals: 0, prot: 0, carbs: 0, fat: 0, airfry: false, bonePercent: 0, yieldPercent: 1.0 });

            // Load Daily Log (Migration Logic included)
            useEffect(() => {
                const log = Storage.getTodayLog();
                if (log) {
                    // Migration: if log.steps is a number, convert to [entry]
                    if (typeof log.steps === 'number') {
                        setActivityLog(log.steps > 0 ? [{ id: 'legacy-steps', amount: log.steps, timestamp: Date.now() }] : []);
                    } else {
                        setActivityLog(log.steps || []);
                    }

                    // Migration: if log.intake is single object, convert to [entry]
                    if (log.intake && !Array.isArray(log.intake) && log.intake.calories > 0) {
                        setFoodLog([{
                            id: 'legacy-food',
                            name: 'Legacy Entry',
                            ...log.intake,
                            timestamp: Date.now()
                        }]);
                    } else if (Array.isArray(log.intake)) {
                        setFoodLog(log.intake);
                    } else {
                        setFoodLog([]);
                    }
                }
            }, []);

            // Save on Change (Save as arrays now)
            useEffect(() => {
                Storage.saveTodayLog({ steps: activityLog, intake: foodLog });
            }, [activityLog, foodLog]);

            // Calculations (Aggregating arrays)
            const steps = useMemo(() => activityLog.reduce((sum, item) => sum + (item.type === 'WORKOUT' ? 0 : item.amount), 0), [activityLog]);

            const intake = useMemo(() => foodLog.reduce((acc, item) => ({
                calories: acc.calories + item.calories,
                protein: acc.protein + item.protein,
                carbs: acc.carbs + item.carbs,
                fat: acc.fat + item.fat
            }), { calories: 0, protein: 0, carbs: 0, fat: 0 }), [foodLog]);

            const tdee = Engine.calculateDynamicTDEE(user.bmr, steps);

            // Calculate Workout Burn
            const workoutBurn = useMemo(() => activityLog.reduce((sum, item) => sum + (item.type === 'WORKOUT' ? item.calories : 0), 0), [activityLog]);

            // Limit Adjust (Base TDEE + Workouts)
            // Note: calculateDynamicTDEE includes step burn. We assume workouts are ADDITIVE to this.
            // If calculateDynamicTDEE output is BMR + Steps, then we need to add WorkoutBurn to that for the dashboard.
            // However, Engine.adjustToGoal relies on the input TDEE.

            const totalDailyBurn = tdee + workoutBurn; // BMR + Steps + Workouts
            const limit = Engine.adjustToGoal(totalDailyBurn, user.goal);

            // Balance Calculations
            const bmr = user.bmr;
            const stepBurn = Math.round((steps / 1000) * 40);
            const activeBurn = stepBurn + workoutBurn;
            // const totalOutput = Math.round(bmr * 1.2 + activeBurn); // Original was BMR*1.2 ?? Wait, Engine.calculateDynamicTDEE does (BMR*1.2) + StepBurn.

            // Let's stick to the Engine's output for consistency.
            // Engine.calculateDynamicTDEE = (BMR * 1.2) + ((steps/1000)*40)
            const totalOutput = totalDailyBurn;

            // "Remaining" Logic (Target - Intake)
            const remaining = limit - intake.calories;

            let status = Engine.getMissionStatus(intake.calories, limit);

            // Re-using balance status logic for Remaining color coding
            let balanceColor = 'var(--hud-blue)';
            if (remaining < 0) balanceColor = 'var(--hud-red)';
            else if (remaining < 200) balanceColor = 'var(--hud-green)';

            // Smart Activity Form State
            const [actType, setActType] = useState('steps'); // steps, run, cycle, lift, sport, custom
            const [actForm, setActForm] = useState({ steps: '', duration: '', distance: '', name: '', calories: '' });

            // Handlers
            const handleAddSmartActivity = () => {
                let entry = null;

                if (actType === 'steps') {
                    const s = parseInt(actForm.steps);
                    if (s && !isNaN(s)) {
                        entry = { type: 'STEPS', amount: s };
                    }
                } else if (actType === 'custom') {
                    const cals = parseInt(actForm.calories);
                    if (actForm.name && cals && !isNaN(cals)) {
                        entry = { type: 'WORKOUT', name: actForm.name, calories: cals };
                    }
                } else {
                    // Smart MET Calculation
                    const duration = parseFloat(actForm.duration);
                    if (duration && !isNaN(duration)) {
                        const weight = user.weight; // Ensure user weight is available
                        const dist = parseFloat(actForm.distance);

                        // Infer intensity from distance if available (e.g. speed)
                        // For now we pass type directly to Engine

                        const burn = Engine.calculateActivityBurn(weight, actType, duration);

                        // Create a descriptive name
                        let name = actType.toUpperCase();
                        if (dist) name += ` (${dist}km)`;
                        name += ` - ${duration}m`;

                        entry = { type: 'WORKOUT', name: name, calories: burn };
                    }
                }

                if (entry) {
                    setActivityLog(prev => [...prev, {
                        id: Date.now().toString(),
                        timestamp: Date.now(),
                        ...entry
                    }]);
                    // Reset proper fields
                    setActForm({ steps: '', duration: '', distance: '', name: '', calories: '' });
                }
            };

            const handleAddFood = () => {
                const base = {
                    protein: parseFloat(foodForm.prot) || 0,
                    carbs: parseFloat(foodForm.carbs) || 0,
                    fat: parseFloat(foodForm.fat) || 0,
                    calories: parseFloat(foodForm.cals) || 0
                };

                const final = Physics.applyPhysics(base, {
                    isAirFried: foodForm.airfry,
                    bonePercent: parseFloat(foodForm.bonePercent) / 100,
                    yieldPercent: parseFloat(foodForm.yieldPercent)
                });

                const newEntry = {
                    id: Date.now().toString(),
                    name: foodForm.name || 'Ration',
                    ...final,
                    timestamp: Date.now()
                };

                setFoodLog(prev => [...prev, newEntry]);
                setIsLogOpen(false);
                setFoodForm({ name: '', cals: 0, prot: 0, carbs: 0, fat: 0, airfry: false, bonePercent: 0, yieldPercent: 1.0 });
            };

            const handleAddSteps = () => {
                const el = document.getElementById('stepsInput');
                const s = parseInt(el.value);
                if (s && !isNaN(s)) {
                    // Type: STEPS (Explicitly set to allow differentiation)
                    setActivityLog(prev => [...prev, { id: Date.now().toString(), type: 'STEPS', amount: s, timestamp: Date.now() }]);
                    el.value = '';
                }
            };

            const handleAddWorkout = () => {
                const nameEl = document.getElementById('workoutName');
                const calEl = document.getElementById('workoutCals');
                const name = nameEl.value;
                const cals = parseInt(calEl.value);

                if (name && cals && !isNaN(cals)) {
                    setActivityLog(prev => [...prev, {
                        id: Date.now().toString(),
                        type: 'WORKOUT',
                        name: name,
                        calories: cals,
                        timestamp: Date.now()
                    }]);
                    nameEl.value = '';
                    calEl.value = '';
                }
            };

            const deleteItem = (type, id) => {
                if (confirm("Confirm DELETE?")) {
                    if (type === 'food') setFoodLog(prev => prev.filter(i => i.id !== id));
                    else setActivityLog(prev => prev.filter(i => i.id !== id));
                }
            };

            // --- NEW FEATURES ---
            const [showReport, setShowReport] = useState(false);

            const handleCloseDay = () => {
                setShowReport(true);
            };

            const confirmCloseDay = () => {
                Storage.clearTodayLog();
                setFoodLog([]);
                setActivityLog([]);
                setShowReport(false);
                alert("Day Closed. Logs cleared for a fresh start.");
            };



            return (
                <div className="container">
                    <Header />

                    {/* Report Modal */}
                    {showReport && (
                        <div className="panel" style={{ position: 'fixed', top: '10%', left: '5%', right: '5%', zIndex: 100, border: '2px solid var(--hud-blue)', background: '#000' }}>
                            <span className="header-text">DAILY MISSION REPORT</span>

                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px', textAlign: 'center', margin: '20px 0' }}>
                                <div>
                                    <div className="input-label">TOTAL INTAKE</div>
                                    <div className="value-huge">{intake.calories}</div>
                                </div>
                                <div>
                                    <div className="input-label">TOTAL OUTPUT</div>
                                    <div className="value-huge">{totalOutput}</div>
                                </div>
                            </div>

                            <div style={{ textAlign: 'center', borderTop: '1px solid #333', paddingTop: '10px' }}>
                                <div className="input-label">REMAINING ALLOWANCE</div>
                                <div className="value-huge" style={{ color: remaining < 0 ? 'var(--hud-red)' : 'var(--hud-blue)' }}>
                                    {remaining}
                                </div>
                            </div>

                            <div style={{ display: 'flex', gap: '10px' }}>
                                <button className="btn" style={{ background: '#333' }} onClick={() => setShowReport(false)}>CANCEL</button>
                                <button className="btn btn-primary" onClick={confirmCloseDay}>CONFIRM END DAY</button>
                            </div>
                        </div>
                    )}

                    {/* Dark Overlay for Modal */}
                    {showReport && <div style={{ position: 'fixed', inset: 0, background: 'rgba(0,0,0,0.8)', zIndex: 90 }}></div>}

                    {/* PANEL 1: MISSION BRIEFING (Calculation Transparency) */}
                    <div className="panel">
                        <span className="header-text">MISSION BRIEFING</span>

                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px', fontSize: '0.9em' }}>
                            <div>
                                <div className="input-label">BASE BMR</div>
                                <div style={{ color: '#fff' }}>{Math.round(bmr)} <span style={{ fontSize: '0.8em', color: '#666' }}>(Mifflin St-Jeor)</span></div>
                            </div>
                            <div style={{ textAlign: 'right' }}>
                                <div className="input-label">ACTIVE TDEE</div>
                                <div style={{ color: '#fff' }}>{Math.round(totalOutput)} <span style={{ fontSize: '0.8em', color: '#666' }}>(BMR + Active)</span></div>
                            </div>
                        </div>

                        <div style={{ borderTop: '1px dashed #444', margin: '10px 0', padding: '10px 0' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                                <span className="input-label">STRATEGY</span>
                                <span style={{ color: user.goal === 'cut' ? 'var(--hud-green)' : (user.goal === 'bulk' ? 'var(--hud-red)' : 'var(--hud-blue)') }}>
                                    {user.goal === 'cut' ? 'INFILTRATE (-500)' : (user.goal === 'bulk' ? 'ASSAULT (+300)' : 'RECON (MAINTAIN)')}
                                </span>
                            </div>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginTop: '5px' }}>
                                <span className="input-label" style={{ color: 'var(--hud-green)' }}>PRIMARY TARGET</span>
                                <span className="value-huge" style={{ fontSize: '1.5em' }}>{limit} <span style={{ fontSize: '0.5em' }}>kcal</span></span>
                            </div>
                        </div>
                    </div>

                    {/* PANEL 2: MISSION STATUS (INTAKE) */}
                    <div className="panel" style={{ textAlign: 'center', borderColor: status.color }}>
                        <span className="header-text">MISSION INTAKE</span>
                        <div className="value-huge" style={{ color: status.color === 'red' ? 'var(--hud-red)' : 'var(--hud-green)' }}>
                            {intake.calories}
                        </div>
                        <span className="input-label" style={{ letterSpacing: '5px' }}>KCAL CONSUMED</span>

                        <div className="gauge-bar" style={{ marginTop: '15px' }}>
                            <div className={`gauge-fill ${status.color === 'red' ? 'fill-red' : 'fill-green'}`} style={{ width: `${Math.min(100, (intake.calories / limit) * 100)}%` }}></div>
                        </div>
                        <div style={{ marginTop: '5px', fontSize: '0.8em', color: status.color, textAlign: 'right' }}>
                            MISSION TARGET: {limit}
                        </div>
                    </div>

                    {/* PANEL 3: REMAINING BUDGET */}
                    <div className="panel" style={{ borderColor: balanceColor }}>
                        <span className="header-text">REMAINING RATION</span>
                        <div style={{ textAlign: 'center' }}>
                            <div className="value-huge" style={{ color: balanceColor }}>
                                {remaining}
                            </div>
                            <div className="input-label">KCAL LEFT</div>
                            <div style={{ marginTop: '10px', fontWeight: 'bold', color: balanceColor, border: '1px solid ' + balanceColor, padding: '5px', display: 'inline-block' }}>
                                {remaining < 0 ? 'MISSION COMPROMISED' : 'OPERATIONAL'}
                            </div>
                        </div>
                    </div>

                    {/* Quick Stats */}
                    <div className="panel">
                        <Gauge label="PROTEIN" value={intake.protein} max={180} unit="g" colorClass="fill-blue" />
                        <Gauge label="CARBS" value={intake.carbs} max={200} unit="g" colorClass="fill-orange" />
                        <Gauge label="FAT" value={intake.fat} max={70} unit="g" colorClass="fill-purple" />
                        <Gauge label="CALORIES" value={intake.calories} max={limit} unit="kcal" colorClass={status.color === 'red' ? 'fill-red' : 'fill-green'} />
                    </div>

                    {/* ACTIONS & LOGGING */}
                    <div className="panel">
                        <span className="header-text">TACTICAL OPS</span>
                        <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                            <button className="btn" onClick={() => setIsLogOpen(!isLogOpen)}>LOG FOOD</button>

                            {/* Smart Activity Logger */}
                            <div className="input-group" style={{ margin: 0 }}>
                                <label className="input-label">LOG ACTIVITY</label>
                                <div style={{ display: 'flex', flexDirection: 'column', gap: '5px' }}>

                                    {/* Type Selector */}
                                    <div style={{ display: 'flex', gap: '5px' }}>
                                        <select className="tactical-input" style={{ width: '100%', cursor: 'pointer', background: '#222' }} value={actType} onChange={e => setActType(e.target.value)}>
                                            <option value="steps">STEPS (Standard)</option>
                                            <option value="run">RUNNING (High Intensity)</option>
                                            <option value="cycle">CYCLING (Moderate)</option>
                                            <option value="lift">LIFTING / GYM</option>
                                            <option value="sport">SPORTS (General)</option>
                                            <option value="custom">MANUAL ENTRY</option>
                                        </select>
                                    </div>

                                    {/* Dynamic Inputs */}
                                    <div style={{ display: 'flex', gap: '5px' }}>
                                        {actType === 'steps' && (
                                            <input type="number" className="tactical-input" placeholder="Count" value={actForm.steps} onChange={e => setActForm({ ...actForm, steps: e.target.value })} style={{ flex: 1 }} />
                                        )}

                                        {(actType === 'run' || actType === 'cycle') && (
                                            <>
                                                <input type="number" className="tactical-input" placeholder="Mins" value={actForm.duration} onChange={e => setActForm({ ...actForm, duration: e.target.value })} style={{ flex: 1 }} />
                                                <input type="number" className="tactical-input" placeholder="Km (Opt)" value={actForm.distance} onChange={e => setActForm({ ...actForm, distance: e.target.value })} style={{ flex: 1 }} />
                                            </>
                                        )}

                                        {(actType === 'lift' || actType === 'sport') && (
                                            <input type="number" className="tactical-input" placeholder="Duration (Minutes)" value={actForm.duration} onChange={e => setActForm({ ...actForm, duration: e.target.value })} style={{ flex: 1 }} />
                                        )}

                                        {actType === 'custom' && (
                                            <>
                                                <input className="tactical-input" placeholder="Desc" value={actForm.name} onChange={e => setActForm({ ...actForm, name: e.target.value })} style={{ flex: 1 }} />
                                                <input type="number" className="tactical-input" placeholder="Kcal" value={actForm.calories} onChange={e => setActForm({ ...actForm, calories: e.target.value })} style={{ width: '80px' }} />
                                            </>
                                        )}

                                        <button className="btn" style={{ width: 'auto', padding: '0 15px' }} onClick={handleAddSmartActivity}>ADD</button>
                                    </div>

                                    {/* Preview (Optional Enhancement) */}
                                    {actType !== 'steps' && actType !== 'custom' && actForm.duration && (
                                        <div style={{ textAlign: 'right', fontSize: '0.8em', color: 'var(--hud-green)' }}>
                                            ESTIMATED BURN: ~{Engine.calculateActivityBurn(user.weight, actType, parseFloat(actForm.duration) || 0)} kcal
                                        </div>
                                    )}
                                </div>
                            </div>

                        </div>
                        <div style={{ marginTop: '10px', textAlign: 'center' }}>
                            <span className="input-label">CURRENT STEPS: {steps}</span>
                        </div>

                        <div style={{ borderTop: '1px solid #333', marginTop: '15px', paddingTop: '10px', display: 'flex', justifyContent: 'space-between' }}>
                            <button style={{ background: 'none', border: '1px solid var(--hud-red)', color: 'var(--hud-red)', padding: '5px 10px', fontSize: '0.8em', cursor: 'pointer' }} onClick={handleResetSystem}>RESET SYSTEM</button>
                            <button style={{ background: 'var(--hud-blue)', border: 'none', color: '#000', padding: '5px 10px', fontSize: '0.8em', fontWeight: 'bold', cursor: 'pointer' }} onClick={handleCloseDay}>CLOSE DAY</button>
                        </div>
                    </div>

                    {/* MISSION LOG (HISTORY) */}
                    <div className="panel">
                        <span className="header-text" style={{ color: 'var(--text-dim)' }}>MISSION LOG</span>

                        {/* Food List */}
                        <div style={{ marginBottom: '10px' }}>
                            <div className="input-label" style={{ borderBottom: '1px solid #333' }}>RATIONS</div>
                            {foodLog.length === 0 && <div style={{ fontSize: '0.8em', color: '#555', fontStyle: 'italic' }}>No rations logged.</div>}
                            {foodLog.slice().reverse().map(item => (
                                <div key={item.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '5px 0', borderBottom: '1px dashed #222' }}>
                                    <div style={{ fontSize: '0.9em' }}>
                                        <span style={{ color: 'var(--hud-blue)' }}>{item.name}</span> <span style={{ fontSize: '0.8em', color: '#666' }}>({item.calories} kcal)</span>
                                    </div>
                                    <button style={{ background: 'none', border: 'none', color: 'var(--hud-red)', cursor: 'pointer', fontSize: '0.8em' }} onClick={() => deleteItem('food', item.id)}>[DEL]</button>
                                </div>
                            ))}
                        </div>

                        {/* Activity List */}
                        <div>
                            <div className="input-label" style={{ borderBottom: '1px solid #333' }}>ACTIVITY</div>
                            {activityLog.length === 0 && <div style={{ fontSize: '0.8em', color: '#555', fontStyle: 'italic' }}>No activity logged.</div>}
                            {activityLog.slice().reverse().map(item => (
                                <div key={item.id} style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', padding: '5px 0', borderBottom: '1px dashed #222' }}>
                                    <div style={{ fontSize: '0.9em' }}>
                                        {item.type === 'WORKOUT' ? (
                                            <>
                                                <span style={{ color: 'var(--hud-orange)' }}>{item.name}</span> <span style={{ fontSize: '0.8em', color: '#666' }}>({item.calories} kcal)</span>
                                            </>
                                        ) : (
                                            <>
                                                <span style={{ color: 'var(--hud-green)' }}>Steps</span> <span style={{ fontSize: '0.8em', color: '#666' }}>({item.amount} / ~{Math.round((item.amount / 1000) * 40)} kcal)</span>
                                            </>
                                        )}

                                    </div>
                                    <button style={{ background: 'none', border: 'none', color: 'var(--hud-red)', cursor: 'pointer', fontSize: '0.8em' }} onClick={() => deleteItem('activity', item.id)}>[DEL]</button>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Food Logger Modal - Simple toggle for now */}
                    {isLogOpen && (
                        <div className="panel" style={{ border: '1px solid var(--hud-blue)' }}>
                            <span className="header-text" style={{ color: 'var(--hud-blue)' }}>NEW RATION ENTRY</span>

                            {/* Smart Scan */}
                            <div className="input-group" style={{ borderBottom: '1px solid #333', paddingBottom: '1rem', marginBottom: '1rem' }}>
                                <label className="input-label">SMART SCAN (e.g. "300g Chicken")</label>
                                <div style={{ display: 'flex', gap: '10px' }}>
                                    <input className="tactical-input" placeholder="Scan food..." id="smartInput" />
                                    <button className="btn" onClick={async () => {
                                        const query = document.getElementById('smartInput').value;
                                        if (!query) return;
                                        try {
                                            const items = await Nutrition.fetchNutrition(query);
                                            if (items && items.length > 0) {
                                                const item = items[0];
                                                setFoodForm({
                                                    name: item.name,
                                                    cals: item.calories,
                                                    prot: item.protein_g || item.protein, // API vs Local
                                                    carbs: item.carbohydrates_total_g || item.carbs,
                                                    fat: item.fat_total_g || item.fat,
                                                    airfry: false,
                                                    bonePercent: 0,
                                                    yieldPercent: 1.0
                                                });
                                            } else {
                                                alert("No intelligence found on this item.");
                                            }
                                        } catch (e) {
                                            alert("Scan Failed: " + e.message);
                                        }
                                    }}>SCAN</button>
                                </div>
                            </div>

                            <div className="input-group">
                                <label className="input-label">Name</label>
                                <input className="tactical-input" value={foodForm.name} onChange={e => setFoodForm({ ...foodForm, name: e.target.value })} />
                            </div>
                            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                                <div className="input-group">
                                    <label className="input-label">Prot (g)</label>
                                    <input type="number" className="tactical-input" value={foodForm.prot} onChange={e => setFoodForm({ ...foodForm, prot: e.target.value })} />
                                </div>
                                <div className="input-group">
                                    <label className="input-label">Carbs (g)</label>
                                    <input type="number" className="tactical-input" value={foodForm.carbs} onChange={e => setFoodForm({ ...foodForm, carbs: e.target.value })} />
                                </div>
                                <div className="input-group">
                                    <label className="input-label">Fat (g)</label>
                                    <input type="number" className="tactical-input" value={foodForm.fat} onChange={e => setFoodForm({ ...foodForm, fat: e.target.value })} />
                                </div>
                                <div className="input-group">
                                    <label className="input-label">Cals (kcal)</label>
                                    <input type="number" className="tactical-input" value={foodForm.cals} onChange={e => setFoodForm({ ...foodForm, cals: e.target.value })} />
                                </div>
                            </div>

                            <div className="input-group" style={{ display: 'flex', alignItems: 'center', gap: '10px', marginTop: '10px' }}>
                                <input type="checkbox" id="af" checked={foodForm.airfry} onChange={e => setFoodForm({ ...foodForm, airfry: e.target.checked })} />
                                <label htmlFor="af" className="input-label" style={{ marginBottom: 0 }}>AIR FRYER MODE (Reduces Fat)</label>
                            </div>

                            {/* Advanced Physics */}
                            <div className="panel" style={{ marginTop: '10px', background: 'rgba(0,0,0,0.3)' }}>
                                <span className="input-label">PHYSICS MODIFIERS</span>
                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '10px' }}>
                                    <div className="input-group">
                                        <label className="input-label">Bone % (Waste)</label>
                                        <input type="number" className="tactical-input" placeholder="e.g. 20" value={foodForm.bonePercent} onChange={e => setFoodForm({ ...foodForm, bonePercent: e.target.value })} />
                                    </div>
                                    <div className="input-group">
                                        <label className="input-label">Yield Factor (0-1)</label>
                                        <input type="number" className="tactical-input" placeholder="e.g. 1.0" value={foodForm.yieldPercent} onChange={e => setFoodForm({ ...foodForm, yieldPercent: e.target.value })} />
                                    </div>
                                </div>
                            </div>

                            <button className="btn btn-primary" onClick={handleAddFood}>CONFIRM ENTRIES</button>
                        </div>
                    )}

                    <Footer />
                </div>
            );
        }

        function App() {
            const [user, setUser] = useState(Storage.getUser());

            const handleReset = () => {
                if (confirm("CRITICAL WARNING: This will FACTORY RESET the app. All data and logs will be lost. Proceed?")) {
                    // Explicitly remove known keys first
                    localStorage.removeItem('ciao_user_v1');
                    localStorage.removeItem('ciao_logs_v1');
                    localStorage.clear(); // Then nuke everything else

                    setUser(null);
                    // Force hard reload via location assignment to bust any state
                    setTimeout(() => {
                        window.location.href = window.location.href;
                    }, 50);
                }
            };

            if (!user) {
                return <Onboarding onComplete={setUser} />;
            }

            return <Dashboard user={user} onReset={handleReset} />;
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>


</html>